---
import { graphql } from '~/lib/datocms/graphql';
import Layout from '~/layouts/Layout.astro';
import { TagFragment } from '~/lib/datocms/commonFragments';
import { executeQuery } from '~/lib/datocms/executeQuery';
import { StructuredText } from '@datocms/astro';

import { VideoBlockFragment } from '~/components/blocks/VideoBlock/fragments';
import { ImageBlockFragment } from '~/components/blocks/ImageBlock/fragments';
import { ImageGalleryBlockFragment } from '~/components/blocks/ImageGalleryBlock/fragments';
import { ResponsiveImageFragment } from '~/components/ResponsiveImage/fragments';

import { isDraftModeEnabled } from '../lib/draftMode';
import { BlockRenderer } from '../components/BlockRenderer';
import { Hero } from '~/components/blocks/Hero';

/**
 * The GraphQL query that will be executed for this route to generate the page
 * content and metadata.
 *
 * Thanks to gql.tada, the result will be fully typed!
 */
const query = graphql(
  /* GraphQL */ `
    query BasicPageQuery {
      page: home {
        _seoMetaTags {
          ...TagFragment
        }
        title
        heroIntroText
        heroImages {
          id
          responsiveImage(
            imgixParams: { fm: jpg, fit: crop, w: 305, h: 305, ar: "1:1" }
            sizes: "(max-width: 305px) 100vw"
          ) {
            ...ResponsiveImageFragment
          }
        }
        blocks {
          __typename
          ... on RecordInterface {
            id
            __typename
          }
          ... on ImageBlockRecord {
            ...ImageBlockFragment
          }
          ... on ImageGalleryBlockRecord {
            ...ImageGalleryBlockFragment
          }
          ... on VideoBlockRecord {
            ...VideoBlockFragment
          }
        }
      }
    }
  `,
  [
    TagFragment,
    ImageBlockFragment,
    ImageGalleryBlockFragment,
    VideoBlockFragment,
    ResponsiveImageFragment,
  ],
);

const draftModeEnabled = isDraftModeEnabled(Astro.cookies);
const { page } = await executeQuery(query, { includeDrafts: draftModeEnabled });

if (!page) {
  return new Response(null, {
    status: 404,
    statusText: 'Not found',
  });
}
---

<Layout additionalSeo={page._seoMetaTags}>
  <Hero title={page.title} images={page.heroImages} introText={page.heroIntroText} />
  <BlockRenderer blocks={page.blocks} />
</Layout>
